# 서비스 추상화
자바에는 사용 방법과 형식은 다르지만 기능과 목적이 유사한 기술이 존재한다. 환경과 상황에 따라서 기술이 바뀌고, 그에 따라 다른 API를 사용하고 다른 스타일의 접근 방법을 따라야 하는 건 피곤한 일이다.

5장에서는 지금까지 만든 DAO에 트랜잭션을 적용해보면서 스프링이 어떻게 성격이 비슷한 여러 종류의 기술을 추상화하고 이를 일관된 방법으로 사용할 수 있도록 지원하는지를 살펴보자.

## 사용자 레벨 관리 기능 추가
지금까지의 UserDao는 User 오브젝트에 담겨 있는 사용자 정보를 CRUD하는 작업만 가능했다. 사용자 정보를 DB에 넣고 빼는 것을 제외하면 어떤 비즈니스 로직도 있지 않다.

여기에 비즈니스 로직을 추가하기 위해 다음과 같은 유저 레벨과 사용자 관리 기능을 추가해보자.
- 사용자의 레벨은 BASIC, SILVER, GOLD
- 가입시에 BASIC, 이후에 활동에 따라 업그레이드가 가능
- 로그인 60회 이상일 경우 BASIC -> SIVLER
- SILVER이면서 추천 30회 이상일 경우 GOLD
- 사용자 레벨 변경 작업은 배치작업으로 진행한다.

### 필드 추가
#### Level 이늄
User 클래스에 사용자의 레벨을 저장할 필드를 추가하자. DB의 User 테이블에는 어떤 타입으로 넣을지, 또 이에 매핑되는 자바의 User 클래스에는 어떤 타입으로 넣을지 생각해보자.

DB에는 varchar 타입은 좋지 않다, 이처럼 일정한 종류의 정보를 문자열로 넣는 것은 좋지 않다, 대신 각 레벨을 코드화해서 숫자로 넣어보자. 범위가 작은 숫자로 관리하면 DB 용량도 적게 차지하고 가벼워서 좋다.
그렇다면 자바에서는 어떻게 표현할까?

##### 숫자로 표현
아래 처럼 상수 값을 정해놓고 int 타입으로 레벨을 사용한다고 해보자.
~~~java
class User {
  private static final int BASIC = 1;
  private static final int SILVER = 2;
  private static final int GOLD = 3;

  int level;

  public void setLevel(int level) {
    this.level = level;
  }
}
~~~

BASIC, SILVER, GOLD처럼 의미 있는 상수도 정의해놨으니 아래처럼 코드로 작성할 수 있다.
~~~java
if(user1.getLevel() == User.BASIC) {
  user1.setLevel(User.SILVER);
}
~~~
문제는 level의 타입이 int이기 때문에 다른 종류의 정보를 넣는 실수를 해도 컴파일러가 체크해주지 못한다는 점이다. 1,2,3 이외의 숫자가 들어가면 기능은 문제없이 돌아가는 것처럼 보이지만 심각한 버그가 만들어진다.

~~~java
user1.setLevel(other.getSum());
user1.setLevel(1000);// 범위를 벗어나는 값을 넣을 가능성
~~~
그래서 숫자 타입을 직접 사용하는 것보다 자바5 이상에서 제공하는 이늄(enum)을 이용하는 게 안전하고 편리하다.

##### 이늄으로 표현
~~~java
public enum Level {
  BASIC(1), SILVER(2), GOLD(3); //세 개의 이늄 오브젝트 정의

  private final int value;

  Level(int value) {//DB에 저장할 값을 넣어줄 생성자를 만든다.
    this.value = value;    
  }

  public int intValue() {//값을 가져오는 메소드
    return value;
  }

  public static Level valueOf(int value) {//값으로부터 Level 타입 오브젝트를 가져오도록 만든 스태틱 메소드
    switch(value) {
      case 1: return BASIC;
      case 2: return SILVER;
      case 3: return GOLD;
      default: throw new AssertionError("Unknown value: " + value);
    }
  }
}
~~~
이렇게 만든 Level 이늄은 내부에는 DB에 저장할 int 타입의 값을 갖고 있지만, 겉으로는 Level 타입의 오브젝트이기 때문에 안전하게 사용할 수 있다. user1.setLevel(1000)과 같은 코드는 컴파일러가 타입이 일치하지 않는다는 에러를 내면서 걸러줄것이다.

#### User 필드 추가
